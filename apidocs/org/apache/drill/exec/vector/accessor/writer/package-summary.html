<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (1.8.0_232) on Tue Dec 24 19:10:39 EET 2019 -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>org.apache.drill.exec.vector.accessor.writer (Apache Drill Root POM 1.17.0 API)</title>
<meta name="date" content="2019-12-24">
<link rel="stylesheet" type="text/css" href="../../../../../../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../../../../../../script.js"></script>
</head>
<body>
<script type="text/javascript"><!--
    try {
        if (location.href.indexOf('is-external=true') == -1) {
            parent.document.title="org.apache.drill.exec.vector.accessor.writer (Apache Drill Root POM 1.17.0 API)";
        }
    }
    catch(err) {
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar.top">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.top" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.top.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-use.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../../../../org/apache/drill/exec/vector/accessor/sql/package-summary.html">Prev&nbsp;Package</a></li>
<li><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/dummy/package-summary.html">Next&nbsp;Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../../../../../index.html?org/apache/drill/exec/vector/accessor/writer/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip.navbar.top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<div class="header">
<h1 title="Package" class="title">Package&nbsp;org.apache.drill.exec.vector.accessor.writer</h1>
<div class="docSummary">
<div class="block">Implementation of the vector writers.</div>
</div>
<p>See:&nbsp;<a href="#package.description">Description</a></p>
</div>
<div class="contentContainer">
<ul class="blockList">
<li class="blockList">
<table class="typeSummary" border="0" cellpadding="3" cellspacing="0" summary="Interface Summary table, listing interfaces, and an explanation">
<caption><span>Interface Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Interface</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/AbstractTupleWriter.TupleWriterListener.html" title="interface in org.apache.drill.exec.vector.accessor.writer">AbstractTupleWriter.TupleWriterListener</a></td>
<td class="colLast">
<div class="block">Listener (callback) to handle requests to add a new column to a tuple (row
 or map).</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/OffsetVectorWriter.html" title="interface in org.apache.drill.exec.vector.accessor.writer">OffsetVectorWriter</a></td>
<td class="colLast">
<div class="block">Interface for specialized operations on an offset vector.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/RepeatedListWriter.ArrayListener.html" title="interface in org.apache.drill.exec.vector.accessor.writer">RepeatedListWriter.ArrayListener</a></td>
<td class="colLast">&nbsp;</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/UnionWriterImpl.UnionShim.html" title="interface in org.apache.drill.exec.vector.accessor.writer">UnionWriterImpl.UnionShim</a></td>
<td class="colLast">&nbsp;</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/WriterEvents.html" title="interface in org.apache.drill.exec.vector.accessor.writer">WriterEvents</a></td>
<td class="colLast">
<div class="block">Internal interface used to control the behavior
 of writers.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/WriterEvents.ColumnWriterListener.html" title="interface in org.apache.drill.exec.vector.accessor.writer">WriterEvents.ColumnWriterListener</a></td>
<td class="colLast">
<div class="block">Listener (callback) for vector overflow events.</div>
</td>
</tr>
</tbody>
</table>
</li>
<li class="blockList">
<table class="typeSummary" border="0" cellpadding="3" cellspacing="0" summary="Class Summary table, listing classes, and an explanation">
<caption><span>Class Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Class</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/AbstractArrayWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">AbstractArrayWriter</a></td>
<td class="colLast">
<div class="block">Writer for an array-valued column.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/AbstractArrayWriter.ArrayObjectWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">AbstractArrayWriter.ArrayObjectWriter</a></td>
<td class="colLast">
<div class="block">Object representation of an array writer.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/AbstractArrayWriter.BaseArrayWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">AbstractArrayWriter.BaseArrayWriter</a></td>
<td class="colLast">&nbsp;</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/AbstractFixedWidthWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">AbstractFixedWidthWriter</a></td>
<td class="colLast">
<div class="block">Base class for writers for fixed-width vectors.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/AbstractFixedWidthWriter.BaseFixedWidthWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">AbstractFixedWidthWriter.BaseFixedWidthWriter</a></td>
<td class="colLast">&nbsp;</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/AbstractFixedWidthWriter.BaseIntWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">AbstractFixedWidthWriter.BaseIntWriter</a></td>
<td class="colLast">
<div class="block">Base class for writers that use the Java int type as their native
 type.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/AbstractObjectWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">AbstractObjectWriter</a></td>
<td class="colLast">
<div class="block">Abstract base class for the object layer in writers.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/AbstractScalarWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">AbstractScalarWriter</a></td>
<td class="colLast">
<div class="block">Base class for concrete scalar column writers including actual vector
 writers, wrappers for nullable types, and shims used to convert types.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/AbstractScalarWriterImpl.html" title="class in org.apache.drill.exec.vector.accessor.writer">AbstractScalarWriterImpl</a></td>
<td class="colLast">
<div class="block">Column writer implementation that acts as the basis for the
 generated, vector-specific implementations.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/AbstractScalarWriterImpl.ScalarObjectWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">AbstractScalarWriterImpl.ScalarObjectWriter</a></td>
<td class="colLast">
<div class="block">Wraps a scalar writer and its event handler to provide a uniform
 JSON-like interface for all writer types.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/AbstractTupleWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">AbstractTupleWriter</a></td>
<td class="colLast">
<div class="block">Implementation for a writer for a tuple (a row or a map.) Provides access to each
 column using either a name or a numeric index.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/AbstractTupleWriter.TupleObjectWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">AbstractTupleWriter.TupleObjectWriter</a></td>
<td class="colLast">
<div class="block">Generic object wrapper for the tuple writer.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/BaseScalarWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">BaseScalarWriter</a></td>
<td class="colLast">
<div class="block">Column writer implementation that acts as the basis for the
 generated, vector-specific implementations.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/BaseVarWidthWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">BaseVarWidthWriter</a></td>
<td class="colLast">
<div class="block">Base class for variable-width (VarChar, VarBinary, etc.) writers.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/BitColumnWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">BitColumnWriter</a></td>
<td class="colLast">
<div class="block">Specialized writer for bit columns.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/ColumnWriterFactory.html" title="class in org.apache.drill.exec.vector.accessor.writer">ColumnWriterFactory</a></td>
<td class="colLast">
<div class="block">Gather generated writer classes into a set of class tables to allow rapid
 run-time creation of writers.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/EmptyListShim.html" title="class in org.apache.drill.exec.vector.accessor.writer">EmptyListShim</a></td>
<td class="colLast">
<div class="block">Internal implementation for a list of (possible) variants when
 the list has no type associated with it at all.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/ListWriterImpl.html" title="class in org.apache.drill.exec.vector.accessor.writer">ListWriterImpl</a></td>
<td class="colLast">
<div class="block">List writer, which is basically an array writer, with the addition
 that each list element can be null.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/MapWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">MapWriter</a></td>
<td class="colLast">
<div class="block">Writer for a Drill Map type.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/MapWriter.ArrayMapWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">MapWriter.ArrayMapWriter</a></td>
<td class="colLast">
<div class="block">Writer for a an array of maps.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/MapWriter.DummyArrayMapWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">MapWriter.DummyArrayMapWriter</a></td>
<td class="colLast">&nbsp;</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/MapWriter.DummyMapWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">MapWriter.DummyMapWriter</a></td>
<td class="colLast">&nbsp;</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/MapWriter.SingleMapWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">MapWriter.SingleMapWriter</a></td>
<td class="colLast">
<div class="block">Writer for a single (non-array) map.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/NullableScalarWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">NullableScalarWriter</a></td>
<td class="colLast">&nbsp;</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/NullableScalarWriter.ChildIndex.html" title="class in org.apache.drill.exec.vector.accessor.writer">NullableScalarWriter.ChildIndex</a></td>
<td class="colLast">&nbsp;</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/ObjectArrayWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">ObjectArrayWriter</a></td>
<td class="colLast">
<div class="block">Writer for an array of either a map or another array.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/OffsetVectorWriterImpl.html" title="class in org.apache.drill.exec.vector.accessor.writer">OffsetVectorWriterImpl</a></td>
<td class="colLast">
<div class="block">Specialized column writer for the (hidden) offset vector used
 with variable-length or repeated vectors.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/RepeatedListWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">RepeatedListWriter</a></td>
<td class="colLast">
<div class="block">Implements a writer for a repeated list.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/ScalarArrayWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">ScalarArrayWriter</a></td>
<td class="colLast">
<div class="block">Writer for a column that holds an array of scalars.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/SimpleListShim.html" title="class in org.apache.drill.exec.vector.accessor.writer">SimpleListShim</a></td>
<td class="colLast">
<div class="block">Shim for a list that holds a single type, but may eventually become a
 list of variants.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/UnionVectorShim.html" title="class in org.apache.drill.exec.vector.accessor.writer">UnionVectorShim</a></td>
<td class="colLast">
<div class="block">Lists can operate in three modes: no type, one type or many
 types (that is, a list of unions.) This shim implements the
 variant writer when the backing vector is a union or a list
 backed by a union.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/UnionWriterImpl.html" title="class in org.apache.drill.exec.vector.accessor.writer">UnionWriterImpl</a></td>
<td class="colLast">
<div class="block">Writer to a union vector.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/UnionWriterImpl.VariantObjectWriter.html" title="class in org.apache.drill.exec.vector.accessor.writer">UnionWriterImpl.VariantObjectWriter</a></td>
<td class="colLast">&nbsp;</td>
</tr>
</tbody>
</table>
</li>
<li class="blockList">
<table class="typeSummary" border="0" cellpadding="3" cellspacing="0" summary="Enum Summary table, listing enums, and an explanation">
<caption><span>Enum Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Enum</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/WriterEvents.State.html" title="enum in org.apache.drill.exec.vector.accessor.writer">WriterEvents.State</a></td>
<td class="colLast">
<div class="block">Tracks the write state of a tuple or variant to allow applying the correct
 operations to newly-added columns to synchronize them with the rest
 of the writers.</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<a name="package.description">
<!--   -->
</a>
<h2 title="Package org.apache.drill.exec.vector.accessor.writer Description">Package org.apache.drill.exec.vector.accessor.writer Description</h2>
<div class="block">Implementation of the vector writers. The code will make much more sense if
 we start with a review of Drill’s complex vector data model. Drill has 38+
 data ("minor") types. Drill also has three cardinalities ("modes"). The
 result is over 120+ different vector types. Then, when you add maps, repeated
 maps, lists and repeated lists, you rapidly get an explosion of types that
 the writer code must handle.

 <h4>Understanding the Vector Model</h4>

 Vectors can be categorized along multiple dimensions:
 <ul>
 <li>By data (minor) type</li>
 <li>By cardinality (mode)</li>
 <li>By fixed or variable width</li>
 <li>By repeat levels</li>
 </ul>
 <p>
 A repeated map, a list, a repeated list and any array (repeated) scalar all
 are array-like. Nullable and required modes are identical (single values),
 but a nullable has an additional is-set ("bit") vector.
 <p>
 The writers (and readers) borrow concepts from JSON and relational theory
 to simplify the problem:
 <p>
 <ul>
 <li>Both the top-level row, and a Drill map are "tuples" and are treated
 similarly in the model.</li>
 <li>All non-map, non-list (that is, scalar) data types are treated
 uniformly.</li>
 <li>All arrays (whether a list, a repeated list, a repeated map, or a
 repeated scalar) are treated uniformly.</li>
 </ul>

 <h4>Repeat Levels</h4>

 JSON and Parquet can be understood as a series of one or more "repeat
 levels." First, let's identify the repeat levels above the batch
 level:
 <ul>
 <li>The top-most level is the "result set": the entire collection of
 rows that come from a file (or other data source.)</li>
 <li>Result sets are divided into batches: collections of up to 64K
 rows.</li>
 </ul>

 Then, within a batch:
 <ul>
 <li>Each batch is a collection or rows. A batch-level index points
 to the current row.</li>
 </ul>Scalar arrays introduce a repeat level: each row has 0, 1 or
 many elements in the array-valued column. An offset vector indexes
 to the first value for each row. Each scalar array has its own
 per-array index to point to the next write position.</li>
 <li>Map arrays introduce a repeat level for a group of columns
 (those that make up the map.) A single offset vector points to
 the common start position for the columns. A common index points
 to the common next write position.<li>
 <li>Lists also introduce a repeat level. (Details to be worked
 out.</li>
 </ul>

 For repeated vectors, one can think of the structure either top-down
 or bottom-up:
 <ul>
 <li>Top down: the row position points into an offset vector. The
 offset vector value points to either the data value, or into another
 offset vector.</li>
 <li>Bottom-up: values are appended to the end of the vector. Values
 are "pinched off" to form an array (for repeated maps) or for a row.
 In this view, indexes bubble upward. The inner-most last write position
 is written as the array end position in the enclosing offset vector.
 This may occur up several levels.</li>
 </ul>

 <h4>Writer Data Model</h4>

 The above leads to a very simple, JSON-like data model:
 <ul>
 <li>A tuple reader or writer models a row. (Usually via a subclass.) Column
 are accessible by name or position.</li>
 <li>Every column is modeled as an object.</li>
 <li>The object can have an object type: scalar, tuple or array.</li>
 <li>An array has a single element type (but many run-time elements)</li>
 <li>A scalar can be nullable or not, and provides a uniform get/set
 interface.</li>
 </ul>
 <p>
 This data model is similar to; but has important differences from, the prior,
 generated, readers and writers. This version is based on the concept of
 minimizing the number of writer classes, and leveraging Java primitives to
 keep the number of get/set methods to a reasonable size. This version also
 automates vector allocation, vector overflow and so on.
 <p>
 The object layer is new: it is the simplest way to model the three "object
 types." An app using this code would use just the leaf scalar readers and
 writers.
 <p>
 Similarly, the <code>ColumnWriter</code> interface provides a uniform way to
 access services common to all writer types, while allowing each JSON-like
 writer to provide type-specific ways to access data.

 <h4>Writer Performance</h4>

 To maximize performance, have a single version for all "data modes":
 (nullable, required, repeated). Some items of note:
 <ul>
 <li>The writers bypass DrillBuf and the UDLE to needed writes to direct
 memory.</li>
 <li>The writers buffer the buffer address and implement a number of methods
 to synchronize that address when the buffer changes (on a new batch or during
 vector resize).</li>
 <li>Writing require a single bounds check. In most cases, the write is within
 bounds so the single check is all that is needed.</li>
 <li>If the write is out of bounds, then the writer determines the new vector
 size and performs the needed reallocation. To avoid multiple doublings, the
 writer computes the needed new size and allocates that size directly.</li>
 <li>Vector reallocation is improved to eliminate zeroing the new half of the
 buffer, data is left "garbage-filled."</li>
 <li>If the vector would grow beyond 16 MB, then overflow is triggered, via a
 listener, which causes the buffer to be replaced. The write then
 continues.</li>
 <li>Offset vector updates are integrated into the writers using an
 `OffsetVectorWriter`. This writer caches the last write position so that each
 array write needs a single offset update, rather than the read and write as
 in previous code.</li>
 <li>The writers keep track of the "last write position" and perform
 "fill-empties" work if the new write position is more than one position
 behind the last write. All types now correctly support "fill-empties"
 (before, only nullable types did so reliably.)</li>
 <li>Null handling is done by an additional writer layer that wraps the
 underlying data writer. This avoids the need for a special nullable writer:
 the same nullable layer works for all data types.</li>
 <li>Array handling is done similarly: an array writer manages the offset
 vector and works the same for repeated scalars, repeated maps and
 (eventually) lists and repeated lists.</li>
 </ul>

 <h4>Lists</h4>

 As described in the API package, Lists and Unions in Drill are highly
 complex, and not well supported. This creates huge problems in the
 writer layer because we must support something which is broken and
 under-used, but which most people assume works (it is part of Drill's
 JSON-like, schema-free model.) Our goal here is to support Union and
 List well enough that nothing new is broken; though this layer cannot
 fix the issues elsewhere in Drill.
 <p>
 The most complex part is List support for the transition from a single
 type to a union of types. The API should be simple: the client should
 not have to be aware of the transition.
 <p>
 To make this work, the writers provide two options:
 <ol>
 <li>Use metadata to state that a List will have exactly one type and
 to specify that type. The List will present as an array of that type in
 which each array can be null.</li>
 <li>Otherwise, the list is repeated union (a array of variants), even
 if the list happens to have 0 or 1 types. In this case, the list presents
 as an array of variants.</li>
 </ol>
 The result is that client code assumes one or the other model, and never
 has to worry about transitioning from one to the other within a single
 operator.
 <p>
 The <code>PromotableListWriter</code> handles the complex details of providing
 the above simple API in the array-of-variant case.

 <h4>Possible Improvements</h4>

 The code here works and has extensive unit tests. But, many improvements
 are possible:
 <ul>
 <li>Drill has four "container" vector types (Map, Union, List, Repeated
 List), each with its own quirky semantics. The code could be far simpler
 if the container semantics were unified.</li>
 <li>Similarly, the corresponding writers implement some very awkward
 logic to handle union and list containers. But, these vectors are not
 fully supported in Drill. This means that the code implements (and tests)
 many odd cases which no one may ever use. Better to limit the data types
 that Drill supports, implement those well, and deprecate the obscure
 cases.</li>
 <li>The same schema-parsing logic appears over and over in different
 guises. Some parse vectors, some parse batch schemas, others parse the
 column metadata (which provides information not available in the
 materialized field) and so on. Would be great to find some common way
 to do this work, perhaps in the form of a visitor. An earlier version of
 this code tried using visitors. But, since each representation has its
 own quirks, that approach didn't work out. A first step would be to come
 up with a standard schema description which can be used in all cases,
 then build a visitor on that.</li>
 <li>Many tests exist. But, the careful reader will note that Drill's
 vectors define a potentially very complex recursive structure (most
 variations of which are never used.) Additional testing should cover
 all cases, such as repeated lists that contain unions, or unions that
 contain repeated lists of tuples.</li>
 <li>Experience with the code may show additional redundancies that can
 be removed. Each fresh set of eyes may see things that prior folks
 missed.</li>
 </ul>

 <h4>Caveats</h4>

 The column accessors are divided into two packages: <tt>vector</tt> and
 <tt>java-exec</tt>. It is easy to add functionality in the wrong place,
 breaking abstraction and encapsulation. Here are some general guidelines:
 <ul>
 <li>The core reader and writer logic is implemented in this <tt>vector</tt>
 package. This package provides low-level tools to build accessors, but
 not the construction logic itself. (That is found in the <tt>java-exec</tt>
 layer.)</li>
 <li>The vector layer is designed to support both the simple "row set" and
 the more complex "result set loader" implementations.</li>
 <li>The "row set" layer wraps the accessors in tools that work on one batch
 (row set) at a time, without regard for schema versions, schema changes
 and the like. The row set layer is primarily for testing: building an input
 batch for some operator, and verifying an output batch. It also serves as a
 simple test framework for the accessors, without the complexity of other
 layers.</li>
 <li>The "result set loader" layer handles the complexity of dynamic schema
 evolution, schema versioning, vector overflow and projection. It provides
 an "industrial strength" version of the accessor mechanism intended for
 use in the scan operator (but which can be generalized for other operators.)
 </li>
 <li>The "listener" pattern is used to allow higher levels to "plug in"
 functionality to the accessor layer. This is especially true for schema
 evolution: listeners notify the higher layer to add a column, delegating
 the actual work to that higher layer.</li>
 </ul>

 Given all this, plan carefully where to make any improvement. If your change
 violates the dependencies below, perhaps reconsider another way to do the
 change.
 <code><pre>
                                                  +------------+
                      +-------------------------- | Result Set |
                      v                           |   Loader   |
             +----------------+     +---------+   +------------+
             |    Metadata    | <-- | Row Set |     |
             | Implementation |     |  Tools  |     |
             +----------------+     +---------+     |
 java-exec           |                     |        |
 ------------------- | ------------------- | ------ | ------------
 vector              v                     v        v
               +------------+            +-----------+
               | Metadata   | <--------- |  Column   |
               | Interfaces |            | Accessors |
               +------------+            +-----------+
                                               |
                                               v
                                          +---------+
                                          |  Value  |
                                          | Vectors |
                                          +---------+
 </pre></code></div>
</div>
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar.bottom">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.bottom" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.bottom.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-use.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../../../../org/apache/drill/exec/vector/accessor/sql/package-summary.html">Prev&nbsp;Package</a></li>
<li><a href="../../../../../../../org/apache/drill/exec/vector/accessor/writer/dummy/package-summary.html">Next&nbsp;Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../../../../../index.html?org/apache/drill/exec/vector/accessor/writer/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip.navbar.bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
<p class="legalCopy"><small>Copyright &#169; 2019 <a href="https://www.apache.org/">The Apache Software Foundation</a>. All rights reserved.</small></p>
</body>
</html>
